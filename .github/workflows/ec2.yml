name: Deploy Frontend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'ComputexFrontend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: SSH into EC2 and set up environment (only runs if Node/Nginx are missing)
      - name: Setup EC2 environment
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ“¦ Updating system..."
            sudo apt update -y
            sudo apt install -y git curl build-essential nginx || true

            # Install Node.js if not installed
            if ! command -v node &> /dev/null; then
              echo "ðŸ“¦ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt install -y nodejs
            fi

            # Ensure web root exists
            sudo mkdir -p /var/www/html
            sudo chown -R $USER:$USER /var/www/html

            # Ensure Nginx config exists for SPA
            if [ ! -f /etc/nginx/sites-available/frontend.conf ]; then
              echo "ðŸ“ Configuring Nginx for frontend..."
              sudo bash -c 'cat > /etc/nginx/sites-available/frontend.conf <<EOF
              server {
                  listen 80;
                  server_name _;
                  root /var/www/html;
                  index index.html;

                  location / {
                      try_files \$uri /index.html;
                  }
              }
              EOF'
              sudo ln -sf /etc/nginx/sites-available/frontend.conf /etc/nginx/sites-enabled/default
              sudo systemctl restart nginx
            fi

      # Step 2: SSH into EC2 and deploy frontend
      - name: Deploy frontend on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ—‘ Cleaning old build..."
            rm -rf ~/ComputexFrontend
            rm -rf /var/www/html/*

            echo "ðŸ“¥ Cloning repository..."
            git clone https://github.com/Oluwapatan-Deborah/Computex.git ~/ComputexFrontend

            echo "ðŸ“¦ Building frontend..."
            cd ~/ComputexFrontend/ComputexFrontend
            npm install
            npm run build

            echo "ðŸ“ Copying build to Nginx root..."
            cp -r dist/* /var/www/html/

            echo "ðŸ”„ Restarting Nginx..."
            sudo systemctl restart nginx

            echo "âœ… Deployment complete! Visit your EC2 IP to see the app."
